{% extends "engines/base_apex.html" %}
{% block title %}Workbench{% endblock %}

{% block content %}
<!-- SIDEBAR: TEMPLATES -->
<aside class="w-80 flex flex-col br-1 bg-black">
    <div class="h-10 flex items-center px-5 bg-zinc-900/20 bb-1 justify-between">
        <span class="label-tiny">Registry_Stack</span>
        <button onclick="document.getElementById('template-upload').click()" class="text-zinc-500 hover:text-white transition">
            <i class="bi bi-plus-lg"></i>
        </button>
        <form id="template-form" action="{{ url_for('engines.upload_template') }}" method="POST" enctype="multipart/form-data" class="hidden">
            <input type="file" id="template-upload" name="file" onchange="this.form.submit()">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        </form>
    </div>
    <div class="flex-1 overflow-auto">
        {% for template in templates %}
        <a href="{{ url_for('engines.workbench', template_id=template.id) }}" 
           class="flex flex-col p-5 border-b-fine hover:bg-[#0c0c0c] transition {% if selected_template and selected_template.id == template.id %}bg-[#0f0f0f] border-l-2 border-blue-600{% endif %}">
            <div class="flex justify-between mb-1">
                <span class="mono text-[10px] text-blue-500">TPL_{{ template.id }}</span>
                <span class="mono text-[9px] text-zinc-600 uppercase">.docx</span>
            </div>
            <div class="text-[11px] font-medium truncate {% if selected_template and selected_template.id == template.id %}text-white{% else %}text-zinc-400{% endif %}">{{ template.name }}</div>
        </a>
        {% else %}
        <div class="p-8 text-center text-zinc-700">
            <i class="bi bi-file-earmark-plus text-3xl mb-4 block"></i>
            <span class="text-[10px] mono uppercase">No Templates Loaded</span>
        </div>
        {% endfor %}
    </div>
    <div class="p-6 bg-zinc-900/10 bt-1">
        <span class="label-tiny block mb-4">Recent_Archive</span>
        <div class="flex flex-col gap-3">
            {% for letter in recent_letters %}
            <div class="p-3 bg-black border border-zinc-900 rounded-sm">
                <div class="flex justify-between text-[9px] mono text-zinc-600 mb-1">
                    <span>#{{ letter.id }}</span> <span>{{ letter.uploaded_at.strftime('%H:%M') }}</span>
                </div>
                <div class="text-[10px] font-medium truncate text-zinc-400">{{ letter.title }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
</aside>

<!-- MAIN WORKSPACE: THE INSPECTOR -->
<main class="flex-1 flex flex-col document-canvas overflow-hidden">
    <div class="h-10 flex items-center justify-between px-6 bg-zinc-900/20 bb-1">
        <div class="flex items-center gap-4">
            <span class="label-tiny">Drafting_Sheet</span>
            {% if selected_template %}
            <span class="mono text-[10px] text-zinc-500 uppercase">{{ selected_template.name }}</span>
            {% endif %}
        </div>
    </div>

    <div class="flex-1 overflow-auto p-12 scroll-smooth">
        <div class="bg-white text-black w-full max-w-[800px] min-height-[1131px] mx-auto p-20 shadow-2xl relative">
            {% if not selected_template %}
            <div class="flex flex-col items-center justify-center h-[600px] text-zinc-300">
                <i class="bi bi-cursor-text text-4xl mb-6"></i>
                <h2 class="serif text-2xl font-light italic">Select a template to begin drafting</h2>
                <p class="mono text-[10px] mt-4 uppercase tracking-widest text-zinc-400">Awaiting_Active_Buffer</p>
            </div>
            {% else %}
            <!-- Mockup Letter Content -->
            <div class="flex justify-between items-start mb-24">
                <div class="w-12 h-12 border-2 border-black flex items-center justify-center font-bold">U</div>
                <div class="text-right">
                    <div class="serif italic text-zinc-400">Institutional Output</div>
                    <div class="mono text-[10px] text-zinc-500 uppercase">Ref: {{ selected_template.id }}/{{ now }}</div>
                </div>
            </div>

            <div class="space-y-10">
                <h1 class="serif text-3xl font-semibold text-black uppercase">{{ selected_template.name.replace('_', ' ') }}</h1>
                <div class="serif text-lg leading-relaxed text-zinc-800 space-y-6">
                    <p>This document is being generated by the <span class="font-bold">Faculty Engine</span>. The placeholders identified in the source .docx are now available for population in the factory control panel.</p>
                    <p>Once finalized, this document will be archived in the system registry and indexed for instantaneous retrieval via the Meilisearch core.</p>
                </div>
                <div class="pt-20">
                    <div class="w-48 border-b border-black mb-2"></div>
                    <div class="serif font-semibold">Authorized Officer</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</main>

<!-- RIGHT PANEL: FACTORY CONTROL -->
<aside class="w-96 bl-1 flex flex-col bg-black">
    <div class="h-10 flex items-center px-5 bg-zinc-900/20 bb-1">
        <span class="label-tiny">Factory_Control</span>
    </div>
    
    {% if selected_template %}
    <div class="p-6 border-b-fine bg-zinc-900/10">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-1.5 h-1.5 bg-blue-500 animate-pulse shadow-[0_0_8px_#0066ff]"></div>
            <span class="mono text-[10px] text-blue-500 uppercase">Input_Required</span>
        </div>
        <form action="{{ url_for('engines.generate') }}" method="POST" class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="template_id" value="{{ selected_template.id }}">
            
            {% for var in variables %}
            <div class="flex flex-col gap-2">
                <label class="label-tiny !text-zinc-500">{{ var.replace('_', ' ') }}</label>
                <input type="text" name="{{ var }}" required
                       class="bg-black border border-zinc-800 rounded-sm py-2 px-3 text-xs mono text-white focus:border-blue-500 outline-none">
            </div>
            {% endfor %}

            <div class="pt-6">
                <button type="submit" class="w-full bg-white text-black py-2.5 rounded-sm text-[11px] font-bold uppercase tracking-tight hover:bg-zinc-200 transition">
                    Generate & Archive
                </button>
            </div>
        </form>
    </div>
    {% else %}
    <div class="p-12 text-center text-zinc-800 flex-1 flex flex-col justify-center">
        <span class="mono text-[10px] uppercase">Awaiting_Template_Selection</span>
    </div>
    {% endif %}

    <div class="p-6 bt-1 bg-zinc-900/10">
        <span class="label-tiny block mb-2">Processing_Trace</span>
        <div class="mono text-[9px] text-zinc-700 space-y-1">
            <div>11:24:01 IDLE</div>
            {% if selected_template %}
            <div class="text-zinc-400">11:24:02 TPL_LOADED: {{ selected_template.id }}</div>
            <div class="text-zinc-400">11:24:02 VARS_EXTRACTED: {{ variables|length }}</div>
            {% endif %}
        </div>
    </div>
</aside>
{% endblock %}
